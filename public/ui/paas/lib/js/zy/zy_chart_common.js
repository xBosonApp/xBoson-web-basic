if(zy){var zy_chart={g:{defaultOptions:{},chart_model:{},data:{},serial_get:null},typeZindex:{area:5,areaspline:30,bar:10,column:10,line:50,pie:0,scatter:10,spline:20,arearange:40,areasplinerange:41,columnrange:0},colorGroup:[["#7cb5ec","#f7a35c","#90ee7e","#7798BF","#aaeeee"],["#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF"],["#ccc479","#99ced1","#99ecf6","#99e0b8","#e7e1c1"],["#b89fb5","#8cc288","#f5fb51","#5d828b","#427894"],["#e7c6e1","#bbd7cb","#ffff9a","#cdebdf","#c5c9ba"]],current_idx:0};function isnul(e){return null==e||""==e}function genid(e){return e+"_"+parseInt(1e5*Math.random())+"_t_"+(new Date).getTime()}function getNextColor(){return++zy_chart.current_idx>=zy_chart.colorGroup.length&&(zy_chart.current_idx=0),zy_chart.colorGroup[zy_chart.current_idx]}function showBox(e,i,t,n,a){var d=[["fa fa-warning shake animated","#C46A69"],["fa fa-bell swing animated","#3276B1"],["fa fa-shield fadeInLeft animated","#C79121"],["fa fa-check","#739E73"]][n=n||0];$.smallBox({title:e,content:i,color:d[1],icon:d[0],timeout:t||(0===n?5e3:2e3)},a)}function showBoxOnly(e,i,t,n){var a=showBoxOnly.caller;a.__show_boox__||(a.__show_boox__=!0,showBox(e,i,t,n,function(){a.__show_boox__=null}))}function args_to_arr(e){for(var i=[],t=0;t<e.length;++t)i[t]=e[t];return i}function get_jar_options(e){return{grid:"article",widgets:".jarviswidget",localStorage:!0,deleteSettingsKey:".deletesettingskey-options",settingsKeyLabel:"重置设置?",deletePositionKey:".deletepositionkey-options",positionKeyLabel:"重置位置?",sortable:!0,buttonsHidden:!1,toggleButton:!0,toggleClass:"fa fa-minus | fa fa-plus",toggleSpeed:200,onToggle:function(){},deleteButton:!0,deleteClass:"fa fa-times",deleteSpeed:200,onDelete:function(){e&&e()},editButton:!0,editPlaceholder:".jarviswidget-editbox",editClass:"fa fa-cog | fa fa-save",editSpeed:200,onEdit:function(){},colorButton:!0,fullscreenButton:!0,fullscreenClass:"fa fa-expand | fa fa-compress",fullscreenDiff:3,onFullscreen:function(){},customButton:!1,customClass:"folder-10 | next-10",customStart:function(){alert("你好, 这是一个自定义按钮...")},customEnd:function(){alert("下次再会...")},buttonOrder:"%refresh% %custom% %edit% %toggle% %fullscreen% %delete%",opacity:1,dragHandle:"> header",placeholderClass:"jarviswidget-placeholder",indicator:!0,indicatorTime:600,ajax:!0,timestampPlaceholder:".jarviswidget-timestamp",timestampFormat:"更新时间: %y%/%m%/%d% %h%:%i%:%s%",refreshButton:!0,refreshButtonClass:"fa fa-refresh",labelError:"对不起有一个错误:",labelUpdated:"最新更新:",labelRefresh:"刷新",labelDelete:"删除 widget:",afterLoad:function(){},rtl:!1,onChange:function(){},onSave:function(){},ajaxnav:$.navAsAjax}}zy_chart.pageSetUp=function(){$.enableJarvisWidgets=!1,window.pageSetUp(),$.enableJarvisWidgets=!0},zy_chart.merge=function(){var e,i,t=arguments,n={},a=function(e,i){var t,n;for(n in"object"!=typeof e&&(e={}),i)i.hasOwnProperty(n)&&((t=i[n])&&"object"==typeof t&&"[object Array]"!==Object.prototype.toString.call(t)&&"renderTo"!==n&&"number"!=typeof t.nodeType?e[n]=a(e[n]||{},t):e[n]=i[n]);return e};for(!0===t[0]&&(n=t[1],t=Array.prototype.slice.call(t,2)),i=t.length,e=0;e<i;e++)n=a(n,t[e]);return n},zy_chart.buildChartHandle=function(e,t,H,n,a){var P,E=$(".chart-template"),F=e,L=0,J=n||"zcp_id_"+location.href.replace(/[/W]|[.]|#|:|[?]/g,"_"),W=a||"s";function R(){return"4E61A380-327D-11E4-8C21-0800200C9A66"==J||"4E61A380-327D-11E4-8C21-0800200C9A80"==J}function d(){$.each(P.chart_setting,function(e,i){U(e)})}function U(e){var i=P.chart_setting[e];Y({mod:"chartbi",api:"html_mod_add",r_parm:{pageid:J,domid:e,modid:i.modid,optdata:JSON.stringify(i)}},function(e){"0"==e.ret?showBox("保存成功","页面设置已经保存完成",0,3):showBox("错误",e.msg)})}function r(i){P={chart_setting:{},order:{},date:[]},Y({mod:"chartbi",api:"html_mod_sel",r_parm:{pageid:J}},function(e){$.each(e.mods,function(e,i){P.chart_setting[i.domid]=JSON.parse(i.optdata),P.order[i.createdt]=i.domid,P.date.push(i.createdt)}),V(),i&&i()})}function V(){P.date.sort(),$.each(P.date,function(e,i){var t=P.order[i];if(t){var n=P.chart_setting[t];V.chart_id=t,c.apply(V,n.create_parm)}})}function Y(e,i,t){var n=this;if(R())var a=$.extend({},e.r_parm,{systag:"1"});else a=$.extend({},e.r_parm);a.dt_from&&(a.flg=a.flg?"1":"0");zy.g.am.mod=e.mod,zy.g.am.app=H,zy.net.get("api/"+e.api,function(e){try{e?i&&i(e):t&&t(e)}catch(e){n.errorHandler&&n.errorHandler(e)}},a)}function o(){return!0}function l(){E=$(".chart-template").html(),r(function(){t({createChartCon:c,updateCharts:o,getChartCount:function(){return L},save_config:d,load_config:r})})}function c(e,t,n,a){var d=arguments;if(!(d.length<1)){++L;var r,u,o,l,p,c,_="column",s=null,f=$("<div></div>").html(E),g=m(),v=zy_chart.createDataComponent(f.find(".date_widget"));return r=(c=this)==V?(s=c.chart_id,P.chart_setting[s]):(s=genid("_ncc_"+J),P.chart_setting[s]={create_parm:args_to_arr(d),modid:null}),function(){switch(f.removeClass("col-lg-5"),f.addClass("col-lg-"+n),f.attr("id",s),f.find(".jarviswidget").attr("id","wid-id-"+s),f.find("#KpiTree").resizable({minHeight:250,minWidth:150}),f.find("#ModTree").resizable({minHeight:250,minWidth:150}),f.find("#searchDiv").draggable({containment:"#"+s}),f.find("#KpiTree").draggable({containment:"#"+s}),f.find("#ModTree").draggable({containment:"#"+s}),W){case"e":f.find('[index="savePlate"]').siblings(".dropdown-toggle").show(),f.find("[index=table]").remove();break;default:f.find('[index="select"]').remove(),f.find('[index="savePlate"]').show()}f.find("#searchDiv").hide(),(o=f.find(".chart-containner")).attr("id",s),(l=$("#"+e)).length<1&&(l=F.append("<div class='row' id='"+e+"'></div>").find("#"+e));l.append(f),f.show()}(),M(a),h(),function(){function i(e,i){return j({mod:e.moduleid,api:e.apiid,title:e.name,dimtag:e.dimtag,tree_data:e,r_parm:v.get()},!0,S,i),g}function t(){u.reflow()}f.find("[index = 'select']").click(function(){f.find("#ModTree ul").empty(),f.find("#ModTree").hide();var e=f.find("#KpiTree").find("ul").children();0<e.length?($(this).html("显示KPI列表"),f.find("#KpiTree").find("ul").children().remove(),f.find("#KpiTree").hide()):($(this).html("关闭KPI列表"),f.find("#KpiTree").show(),Y({mod:"chartbi",api:"chartkpiall"},function(e){f.find('[name="oldmod"]').html("显示模块列表"),f.find(".tree").find("ul").children().remove(),f.find("[index=searchTree]").val(""),D(e.mods,f,i),t()}))}),f.find("[index='closeKpi']").click(function(){f.find("#KpiTree").find("ul").children().remove(),f.find("#KpiTree").hide(),f.find('[index="select"]').html("显示KPI列表"),f.find("[name='oldmod']").html("显示模块列表"),t()}),f.find("[name='oldmod']").click(function(){f.find("#KpiTree").hide(),f.find("#KpiTree").find("ul").children().remove(),0<f.find("#ModTree li").length?($(this).html("显示模块列表"),f.find("#ModTree").find("ul").children().remove(),f.find("#ModTree").hide()):($(this).html("关闭模块列表"),zy_chart._showOrHide(f,["saveAs"],!0),f.find("#KpiTree").hide(),f.find("#ModTree").show(),f.find('[index="mod"]').show(),Y({mod:"chartbi",api:"mod_json_sel"},function(e){f.find('[index="select"]').html("显示KPI列表"),f.find("#ModTree").find("ul").children().remove(),T(e.pids,f),t()}))}),f.find("[index = 'closeMod']").click(function(){f.find('[index="select"]').html("显示KPI列表"),f.find("[name='oldmod']").html("显示模块列表"),f.find("#ModTree").find("ul").children().remove(),f.find("#KpiTree").find("ul").children().remove(),f.find("#ModTree").hide(),t()}),f.find("[index='SearchDiv']").click(function(){0<f.find("[index='minSearchDiv']").closest("div.navbar-form:visible").length?($(this).html("显示查询条件"),f.find("[index='minSearchDiv']").closest("div.navbar-form").hide()):($(this).html("关闭查询条件"),f.find("[index='minSearchDiv']").closest("div.navbar-form").show())}),f.find("[index='closeSearchDiv']").click(function(){f.find("[index='SearchDiv']").html("显示查询条件"),$(this).closest("div.navbar-form").hide()}),f.find("[index='minSearchDiv']").click(function(){$(this).children("i").hasClass("fa-minus")?($(this).closest("div.navbar-form").css("width","20%"),$(this).children("i").removeClass("fa-minus"),$(this).children("i").addClass("fa-plus"),$(this).parent().siblings().hide()):($(this).closest("div.navbar-form").css("width","55%"),$(this).parent().siblings().show(),$(this).children("i").removeClass("fa-plus"),$(this).children("i").addClass("fa-minus"))}),f.find("#KpiTree").hide(),f.find("#ModTree").hide(),f.find('[index="mod"]').hide(),zy_chart._showOrHide(f,["config","clear","table","search"],!1),zy_chart._btnDisable(f,["save","saveAs"],!0),f.find(".form-group").hide(),f.find(".input-sm").val(""),f.find("[index='saveAs']").click(function(){if(zy_chart.g.appnm=H,zy_chart.g.kpiconfig=y(),zy_chart.g.kpiconfig._admin=R(),0==zy_chart.g.kpiconfig.kpis.length)return!1;zy.net.loadHTML("bi/html/zy_chart_saveAs.html",$(".modelform"))}),f.find("[index ='reset']").click(function(){zy_chart._showOrHide(f,["config","clear","table","search"],!1),f.find(".form-group").hide(),zy_chart._btnDisable(f,["save"],!0),f.find(".widget-body").find("ul").children().remove(),$(this).btnDisable(!0)}),f.find("[name='newmod']").click(function(){f.find(".jarviswidget-editbox").hide(),f.find(".form-group").hide(),zy_chart._showOrHide(f,["saveAs","config","clear","search"],!1),zy_chart._btnDisable(f,["save","saveAs"],!0),f.find("#ModTree").hide(),f.find('[index="select"]').html("显示KPI列表"),f.find(".tree").find("ul").children().remove(),f.find("#KpiTree").show(),h(),Y({mod:"chartbi",api:"chartkpiall"},function(e){f.find(".tree").find("ul").children().remove(),f.find("[index=searchTree]").val(""),D(e.mods,f,i),t()})}),f.find('[index="config"]').click(function(){zy_chart.g.appnm=H,zy_chart.g.kpiconfig=y(),zy.net.loadHTML("bi/html/zy_chart_selectTable.html",$(".modelform"))}),f.find('[index="clear"]').click(function(){zy_chart._btnDisable(f,["config","clear","table","search","save"],!0),f.find("#KpiTree").is(":visible")&&(f.find("#KpiTree").find("ul").children().remove(),Y({mod:"chartbi",api:"chartkpiall"},function(e){f.find('[name="oldmod"]').html("显示模块列表"),f.find(".tree").find("ul").children().remove(),f.find("[index=searchTree]").val(""),D(e.mods,f,i),t()})),f.find("#searchDiv").hide(),f.find('[index="SearchDiv"]').btnDisable(!0),f.find('[index="SearchDiv"]').html("显示查询条件"),h(),M(g.modulename)}),f.find('[index="save"]').click(function(){zy_chart.g.appnm=H,zy_chart.g.kpiconfig=y();var e={mod:"chartbi",api:"mod_json_add",r_parm:{modid:zy_chart.g.kpiconfig.moduleid,modnm:zy_chart.g.kpiconfig.modulename,jsondata:JSON.stringify(zy_chart.g.kpiconfig),modtype:zy_chart.g.kpiconfig.moduleclass,shareable:zy_chart.g.kpiconfig.shareable}};if(zy_chart.g.kpiconfig._admin=R(),zy_chart.g.kpiconfig._admin&&(e.r_parm.systag="1"),0==zy_chart.g.kpiconfig.kpis.length)return!1;null==zy_chart.g.kpiconfig.moduleid||""==zy_chart.g.kpiconfig.moduleid?zy.net.loadHTML("bi/html/zy_chart_saveAs.html",$(".modelform")):(zy_chart.g.kpiconfig.update({act:"beforeSave"}),Y(e,function(e){zy_chart.g.kpiconfig.update({act:"save",moduleid:e.res[0].data}),$("#zy_chart_selectTable").modal("hide"),zy.ui.msg("提示信息：","模块:  "+zy_chart.g.kpiconfig.modulename+"  修改成功","s")}))}),zy_chart.pageSetUp()}(),r.modid&&w(r.modid,function(e){var t,n=e.kpis[0].r_parm;if(e.kpis[0].r_parm.autotime)for(i in e.kpis)(n=e.kpis[i].r_parm).flg=!1,n.dt_from="",v.fill_default(n);v.set(n),v.fix(n),b(e),A(C(n)),t=["save","config","clear","table","search","saveAs","SearchDiv"],zy_chart._showOrHide(f,t,!0),zy_chart._btnDisable(f,t,!1),f.find(".form-group").show(),zy_chart.g.kpiconfig=y()}),function(){function i(n){jQuery.fn.dataTableExt.oSort["chinese-asc"]=function(e,i){return e.localeCompare(i)},jQuery.fn.dataTableExt.oSort["chinese-desc"]=function(e,i){return i.localeCompare(e)},jQuery.fn.dataTableExt.aTypes.push(function(e){return/^[\u4e00-\u9fa5]{0,}$/.test(e)?"chinese":null});var e={language:{sProcessing:"处理中...",sLengthMenu:"显示 _MENU_ 项结果",sZeroRecords:"没有匹配结果",sInfo:"显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",sInfoEmpty:"显示第 0 至 0 项结果，共 0 项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索:",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:": 以升序排列此列",sSortDescending:": 以降序排列此列"}},searching:!1,paging:!0};$("[index=fileName]").val(g.fileid),e=$.extend({},e,n);var i,a,t=$("#zy_table").DataTable(e),d=$.extend({},e);d.paging=!1,$("#ods").DataTable(d),$("#ods_wrapper").hide(),$(".dataTables_length").removeClass("dataTables_length"),i=n.columns,a="显示/隐藏: ",$.each(i,function(t,e){$.each(e,function(e,i){"title"==e&&(a=a+"-<a class='toggle-vis' data-column='"+t+"'>"+i+"</a>")})}),$("#zy_slider_bar").html(a),$("a.toggle-vis").on("click",function(e){e.preventDefault();var i=t.column($(this).attr("data-column"));i.visible(!i.visible())}),$("[index=outData]").click(function(){var t,e=$("#ods").table2CSV({separator:",",delivery:"value",header:(t=[],$.each(n.columns,function(e,i){t.push(i.title)}),t)});!function(e){var i=g.kpis[0].r_parm.dt_from+" ~ "+g.kpis[0].r_parm.dt_to;zy.g.am.mod="chartbi",zy.g.am.app=H;var t={chartdata:e,filenm:g.fileid,rowcount:n.data.length,colcount:n.data[0].length||0,condition:i};zy.net.postDownload("download/chart_prol_build",t)}(e)}),$("[index=upfile]").click(function(){var e,i;""!=$("[index=fileName]").val()?(zy.g.am.app=H,zy.g.am.mod="chartbi",zy.net.postForm("upload/uploadchart",(e=g,(i=$("[name=file]").closest("form")).children("input").remove(),$('<input type="hidden">').attr("name","modid").val(e.moduleid).appendTo(i),$('<input type="hidden">').attr("name","up_type").val("chart").appendTo(i),i),function(e){if(e){var i=e.result[0].file_name;Y({api:"mod_fileid_add",mod:"chartbi",r_parm:{modid:g.moduleid,fileid:i}},function(e){g.fileid=i,$("[index=fileName]").val(i),zy.ui.msg("提示信息","模板上传成功","s")})}})):zy.ui.msg("提示信息","请点击选择新模板","w")})}var e=f.find(".chart-title").html();M(""),$.enableJarvisWidgets=!1;var t=get_jar_options(x);"e"==W&&(t.deleteButton=!1,t.toggleButton=!1);f.jarvisWidgets(t),$.enableJarvisWidgets=!0,M(e),f.find("[index=search]").click(function(){$.each(g.kpis,function(e,i){i.update({action:"date"})})}),f.find("[index=table]").click(function(){zy_chart.g.appnm=H;var n,a,e=(n={data:[],columns:[{title:g.dimtag}]},a=[],$.each(u.xAxis[0].categories,function(e,i){a[e]=[i]}),$.each(u.series,function(e,i){var t=e+1;n.columns[t]={title:i.name+" ("+i.options.unit+")"},$.each(i.data,function(e,i){a[i.x][t]=i.y})}),$.each(a,function(e,i){if(1<i.length){for(var t=n.columns.length-1;0<=t;--t)i[t]||(i[t]="");n.data.push(i)}}),a=null,n);0<e.data.length?($.enableJarvisWidgets=!1,zy.net.loadHTML("bi/html/zy_chart_table.html",$(".modelform")),i(e),$.enableJarvisWidgets=!0):showBoxOnly("数据表格","表格中没有数据",3e3,1)}),f.find("[index=savePlate]").click(function(){r.modid=g.moduleid,U(s)})}(),f.find(".jarviswidget-fullscreen-btn").click(function(){f.find("#searchDiv").hide(),f.find("#KpiTree").hide(),f.find("#ModTree").hide(),f.find("#KpiTree").find("ul").children().remove(),f.find("#ModTree").find("ul").children().remove(),f.find("[name=oldmod]").html("显示模块列表"),f.find("[index=select]").html("显示KPI列表"),f.find("[index=SearchDiv]").html("显示查询条件"),0<$("#jarviswidget-fullscreen-mode").length?(f.find("#searchDiv").draggable({containment:"#"+f.attr("id")}),f.find("#KpiTree").draggable({containment:"#"+f.attr("id")}),f.find("#ModTree").draggable({containment:"#"+f.attr("id")})):(f.find("#searchDiv").draggable({containment:"#jarviswidget-fullscreen-mode"}),f.find("#KpiTree").draggable({containment:"#jarviswidget-fullscreen-mode"}),f.find("#ModTree").draggable({containment:"#jarviswidget-fullscreen-mode"})),setTimeout(function(){u.reflow()},300)}),{pushData:function(e){j(e,!0)},clear_data:f._clear_data=h,set_title:M,id:s,chart_obj:u,container:o}}function h(e){var i,t,n=(i={title:""},t={drilldown:I,drillup:O},{colors:getNextColor(),title:{text:i.title},chart:{events:t,defaultSeriesType:_},legend:{},tooltip:{},yAxis:[{title:""}],xAxis:{categories:[]},series:[],credits:{enabled:!1},drilldown:{drillUpButton:{position:{y:0,x:0}}}});u=o.highcharts(n).highcharts(),p={yAxis:[],xAxis:[],title:[],series:[],dt_from:[],sub_title:[],kpi_configs:[],x_index:{},x_index_ar:[],_opposite:!0,x_previous_val:null,drill_level:0,x_type_parm:[]},e?(g.x_type=null,g.kpis=[]):g=m()}function m(){return{modulename:null,moduleid:null,kpis:[],x_type:null,dimtag:null,moduleclass:null,update:z}}function y(){return g}function x(){Y({mod:"chartbi",api:"html_mod_del",r_parm:{pageid:J,domid:s}},function(e){"0"!=e.ret?showBox("错误",e.msg):(P.chart_setting[s]=null,delete P.chart_setting[s])})}function b(i){var t,n=-1;function a(){var e;++n<i.kpis.length&&(t=i.kpis[n],(e=t).title=g.modulename,e.tree_data={name:e.name,leveld:!0},j(e,!0,S,a))}a()}function k(e){w(e.modid,function(e){0==p.drill_level&&(r.modid=g.moduleid);var t=e.kpis[0].r_parm;if(e.kpis[0].r_parm.autotime)for(i in e.kpis)(t=e.kpis[i].r_parm).flg=!1,t.dt_from="",v.fill_default(t);v.set(t),v.fix(t),b(e),A(C(t))})}function w(e,n){Y({mod:"chartbi",api:"mod_json_selone",r_parm:{modid:e}},function(e){var i=e.mods[0];try{var t=JSON.parse(i.jsondata);g.moduleid=i.modid,g.modulename=i.modnm,g.moduleclass=i.modtype,g.fileid=i.fileid,"1"==i.shareable?g.shareable=i.shareable:g.shareable="0",n&&n(t)}catch(e){zy.log("_read_mod_from_server : Err",e.stack||e)}})}function z(e){var t;"beforeSave"!=e.act?(e.moduleid&&(g.moduleid=e.moduleid),0==p.drill_level&&(r.modid=g.moduleid),"submit"==e.act&&zy_chart._btnDisable(f,["save","saveAs"],!1),$.each(g.kpis,function(e,i){i.update({action:"display"})}),t=[],$.each(g.kpis,function(e,i){i.removed||t.push(i)}),g.kpis=t,0===g.kpis.length&&(g.dimtag="",f.find("#KpiTree").hide(),f.find("#KpiTree").find("ul").empty(),f.find("[index=select]").html("显示KPI列表")),M(g.modulename)):$.each(g.kpis,function(e,i){i.r_parm=v.get()})}function T(e,i){var i=f.find("#ModTree").find("ul"),t=e,n={view:{showTitle:false,selectedMulti:false,showIcon:false,dblClickExpand:false},data:{key:{name:"name"},simpleData:{enable:false}},edit:{drag:{isCopy:false,isMove:false},showRenameBtn:false,showRemoveBtn:false,enable:true},callback:{onClick:a}};function a(e,i,t,n){if(!t.children){f._clear_data();f.find(".jarviswidget-editbox").show();zy_chart._showOrHide(f,["config","clear","table","search","SearchDiv"],true);zy_chart._btnDisable(f,["save","config","clear","table","search","saveAs","SearchDiv"],false);f.find(".form-group").show();f.find('[index="mod"]').show();k({modid:t.modid})}}var d=$.fn.zTree.init(i,n,t)}function D(e,a,d){function r(e){var i,t;a.find("[index=searchTree]").select2("destroy"),a.find("[index=searchTree]").zySelectCustomData("",!1,{},(i=e,t=[],$.each(i,function(e,i){i.children&&$.each(i.children,function(e,i){i.isHidden||t.push({id:i.name,name:i.name,text:i.name})})}),t))}a.find("[index=searchTree]").change(function(){if($(".selectnode").removeClass("selectnode"),""!=$(this).parent().children("input").val()){var e=$(this).parent().children("input").val(),i=o.getNodeByParam("name",e,null);o.selectNode(i),$("#"+i.tId+"_a").addClass("selectnode")}});var i=a.find("#KpiTree").find(".ztree"),t=e;!function t(e){$.each(e,function(e,i){i.children?t(i.children):i.isParent=!0})}(t);var n={view:{showTitle:!1,selectedMulti:!1,showIcon:!1,dblClickExpand:!1},data:{key:{name:"name"},simpleData:{enable:!1}},edit:{drag:{isCopy:!1,isMove:!1},showRenameBtn:!1,showRemoveBtn:!1,enable:!0},callback:{onClick:function(e,i,t,n){0<t.level&&(d(t,function(){if(g.dimtag&&""!=g.dimtag){var e=o.getNodesByFilter(l,!1);o.hideNodes(e),r(o.getNodes())}}),a.find(".jarviswidget-editbox").show(),zy_chart._showOrHide(a,["config","clear","table","search","SearchDiv"],!0),zy_chart._btnDisable(a,["save","config","clear","table","search","saveAs","SearchDiv"],!1),a.find(".form-group").show(),a.find('[index="mod"]').show())},onExpand:function(e,i,t){0<t.level?t.children||Y({mod:(n=t).moduleid,api:n.apiid,parm:{dt_type:4,dt_from:"1800-01-01",dt_to:"1800-01-01"}},function(e){e.kpilist&&$.each(e.kpilist[0].apidata,function(e,i){var t={};t.name=i.name,t.apiid=n.apiid,t.moduleid=n.moduleid,t.leveld="i",t.dimtag=n.dimtag,o.addNodes(n,t)})}):t.children&&0<t.children.length&&$.each(t.children,function(e,i){g.dimtag&&i.dimtag!=g.dimtag?o.hideNode(i):o.showNode(i)});var n}}};var o=$.fn.zTree.init(i,n,t);function l(e){return 0<e.level&&e.dimtag!=g.dimtag}if(g.dimtag&&""!=g.dimtag){var c=o.getNodesByFilter(l,!1);o.hideNodes(c)}r(o.getNodes())}function S(e,t){if(t.tree_data.leveld){var i=e.kpilist[0].apidata,n=[];$.each(i,function(e,i){i.name==t.tree_data.name&&n.push(i)}),e.kpilist[0].apidata=n}}function M(e){f.find(".chart-title").html(e)}function C(e){return e.flg?e.dt_from+" ~ "+e.dt_to:e.dt_from}function A(e,i){u&&(i&&p.sub_title.push(i),u.setTitle({text:e},{text:p.sub_title.join(" > ")},!1))}function B(e){return g.dimtag?""!=g.dimtag&&!(g.dimtag==e.kpilist[0].dimtag):(g.dimtag=e.kpilist[0].dimtag,!1)}function K(e){try{var t=v.parseType(e.datelist[0].datelists);if(t<0&&(t=e.kpilist[0].x_type),g.x_type){var n=!0;return $.each(g.x_type,function(e,i){n=t[e]==i&&n,0}),$.each(t,function(){0}),!1}return g.x_type=t,!1}catch(e){}return!1}function j(d,r,o,l){var c=this;return Y.call(c,d,function(e){var i,a,t,n=[];if(K(e)||B(e))return zy.log(K(e)),zy.log(B(e)),void showBox("无效的操作","当前指标的数据与图表中数据格式不兼容, 无法合并");o&&o(e,d),a={},t=(i=e).kpilist[0].apidata,$.each(t,function(e,i){var t=i.unit;if(null!=t&&""!=t||(t=i.name),a[i.name]=e,i.y_id=t,!u.get(t)){var n={gridLineInterpolation:"polygon",labels:{formatter:function(){return function(t){function e(e,i){return e<=t&&(t=(t/e).toFixed(2).replace(/\.00|0$/g,"")+i,!0)}return e(1e8,"亿")||e(1e7,"千万")||e(1e6,"百万")||e(1e4,"万")||e(1e3,"千"),t}(this.value)+i.unit}},title:{text:""},opposite:p._opposite,id:t};p._opposite=!p._opposite,u.addAxis(n,!1,!1)}}),i.y_index=a,N(e,0==c.series_count),function(n,a,h){var e=n.kpilist[0].apidata,l=(n.y_index,n.kpilist[0].x_type),d=[];$.each(e,function(e,o){var i=[],l=o.name,c=(o.kpiid&&o.kpiid,h.mod+"_"+h.api+"_"+l+"_"+p.drill_level),t=h.type||o.type||_;if(u.get(c))d.push(l);else{a.push({name:l,type:t,data:i,yAxis:o.y_id,id:c,unit:o.unit,zIndex:zy_chart.typeZindex[t]}),m(n,i,l,o,f);var s={mod:h.mod,api:h.api,kpiid:o.kpiid,name:l,unit:o.unit,type:t,r_parm:h.r_parm,visible:h.visible||1,drill_moduleid:h.drill_moduleid,drill_modulename:h.drill_modulename,update:function(e){var i,n,a,d,r,t;if(e)switch(e.action){case"date":i=s,n=l,a=o,d=c,r=f,t=$.extend({},h,!0),i.r_parm=t.r_parm=$.extend({},h.r_parm,v.get()),v.rmNotDate(i.r_parm),A(C(i.r_parm)),Y(t,function(e){var i=[];S(e,h),N(e,!0),m(e,i,n,a,r);var t=u.get(d);t.setData(i),t.userOptions.data=i});break;case"display":!function(e,i){if(e.removed)u.get(i).remove();else{var t=u.get(i);t.update({type:e.type}),t.setVisible(1==e.visible)}}(s,c)}}};v.rmNotDate(s.r_parm),g.kpis.push(s),u.reflow()}function f(){return s}}),0<d.length&&showBox("拖拽的指标已经在图表中",d.join(","),null,2);function m(e,i,a,d,r){var o=e.x_index;$.each(e.data,function(e,t){var n={name:"pie"==d.type?t.datetag:void 0,y:parseFloat(t[a]),x:o[t.datetag],drilldown:!0,drill_data:{mod:d.mod,kpiid:d.kpiid,x_type:{},get_drill_conf:r},events:{}};null!=n.x&&(l&&l.length&&$.each(l,function(e,i){n.drill_data.x_type[i]=t[i]}),i.push(n))})}}(e,n,d),r?$.each(n,function(e,i){u.addSeries(i,!1)}):$.each(n,function(e,i){0==c.series_count?u.addSeriesAsDrilldown(c.event.point,i,p.drill_level):(u.addSeries(i,!1),c.add_series.push(i.id)),c.series_count++}),M(g.modulename||d.title||e.title),u.redraw(),l&&l()}),this}function N(e,i){var n,a=u.xAxis[0];n=i?(a.categories=[],p.x_index={}):p.x_index||{},e.datelist&&$.each(e.datelist,function(e,i){var t=i.datelists;null==n[t]&&(a.categories.push(t),n[t]=a.categories.length-1)}),p.x_index=e.x_index=n}function O(e){p.drilling||(u.xAxis[0].categories=p.xAxis.pop(),p.x_index=p.x_index_ar.pop(),$.each(p.series.pop(),function(e,i){u.get(i).remove()}),p.x_previous_val=p.dt_from.pop(),g=p.kpi_configs.pop(),p.x_type_parm.pop(),p.sub_title.pop(),M(g.modulename),p.drill_level--,u.redraw())}function I(a){if(!p.drilling){p.drilling=!0;var e=this,d=a.point.drill_data,i=d.get_drill_conf();if(i.drill_moduleid){var t=[],r={add_series:t,series_count:0,sub_title:"",event:a,errorHandler:o};p.kpi_configs.push(g),p.series.push(t),p.dt_from.push(p.x_previous_val),p.drill_level++,p.xAxis.push(e.xAxis[0].categories),p.x_index_ar.push(p.x_index),g=m(),p.x_type_parm.push(d.x_type),w(i.drill_moduleid,function(e){var i=-1;function n(){var t;++i<e.kpis.length?((t=e.kpis[i]).title=g.modulename,t.tree_data={name:t.name,leveld:!0},t.r_parm=function(e,i){var c=$.extend({dt_from:null,dt_to:null,flg:!1,dt_q:0,dt_type:0},i.x_type);function t(e){var i,t,n,a,d=v.parseType(e);if(0<d){var r=e,o=e,l=d;switch(d){case 1:r+="-01",o+="-12";case 3:r+="-01",t=(i=o).length,n=i.substring(0,4),a=i.substring(t-2),o=i+="04"==a||"06"==a||"09"==a||"11"==a?"-30":"02"==a?n%4==0&&n%100!=0||n%100==0&&n%400==0?"-29":"-28":"-31"}2==++l&&l++,4<l&&(l=4),c.dt_type=l,c.dt_from=r,c.dt_to=o,c.flg=!0,p.x_previous_val=e,v.fix(c)}}return 0<v.parseType(e)?t(e):p.x_previous_val?t(p.x_previous_val):c=$.extend(c,v.get()),v.completed(c)}(a.point.category,d),$.each(p.x_type_parm,function(e,i){t.r_parm=$.extend({},i,t.r_parm)}),j.call(r,t,!1,S,n)):p.drilling=!1}0<e.kpis.length?n():(showBoxOnly("钻取数据","在 ["+g.modulename+"] 中没有收到任何数据，请配置该 MOD 后重试.",6e3,2),o())})}else p.drilling=!1}function o(){p.drilling=!1,O()}}}zy_chart.g.mark=W,E.size()<1?zy.net.loadHTML("bi/html/zy_chart_widget.html",e,l):l()},zy_chart.createDataComponent=function(e,i){zy.net.loadHTML("bi/html/zy_chart_date.html",e);var n=e.find("[index=dt_from]"),a=e.find("[index=dt_to]"),t=e.find("[index=dt_type]"),d=e.find("[index=dt_flag_state]"),r=e.find("[index=dt_flag]"),o=1,l=3,c=4,s=2,f={dt_from:1,dt_to:1,dt_type:1,flg:1,dt_q:1,autotime:1};function h(e){if(e.flg){if(!isnul(e.dt_from)&&!isnul(e.dt_to))return}else if(!isnul(e.dt_from))return;var n=new Date;function i(e,i,t){return n.getFullYear()+e+"-"+a(n.getMonth()+1+i)+"-"+a(n.getDate()+t)}function a(e){return e<10?"0"+e:e}if(e.autotime=!0,v(e.dt_from)<0)switch(parseInt(e.dt_type)){case c:e.dt_from=i(0,0,-1);break;case l:e.dt_from=i(0,-1,0);break;case o:e.dt_from=i(-1,0,0)}e.flg&&(e.dt_to=e.dt_from)}function m(i){function e(e){switch(parseInt(i.dt_type)){case o:e=e.replace(/-[0-9]{1,2}-/g,"-01-");case l:e=e.replace(/-[0-9]{1,2}$/g,"-01")}return e}return i.dt_from=e(i.dt_from),i.dt_to=e(i.dt_to),i}function u(i){function e(e){switch(v(i[e])){case o:i[e]+="-01";case l:i[e]+="-01"}}return e("dt_from"),e("dt_to"),i}function p(n){var a,d=0,r='<tr><td colspan="7"><span class="season month" season="1">第一季度</span><span class="season month" season="2">第二季度</span><span class="season month" season="3">第三季度</span><span class="season month" season="4">第四季度</span></td></tr>';function i(e,i){var t=n.data("datepicker").picker.find(".datepicker-months tbody");a=t.html(),t.html(i||r),t.find(".season").css({clear:"both",width:"100%"}),t.find("[season="+d+"]").addClass("active")}function t(e){var i=e.date;i&&(d=i.getMonth()+1)}function o(){n.off("change",o);var e,i,t=n.datepicker("getDate");0<t.getFullYear()&&(e=t,i||(i=e.getMonth()<3?1:8<e.getMonth()?4:e.getMonth()<6?2:3),d=i,e.setMonth(i-1),n.datepicker("setDate",t))}n.on("change",o),n.on("changeDate",t),n.on("changeYearFillover",i),n.click(i),n.data("removeSeason",function(){n.off("click",i),n.off("changeYearFillover",i),n.off("changeDate",t),n.off("change",o),i(0,a),n.removeData("removeSeason");var e=n.datepicker("getDate");0<e.getDay()&&(e.setMonth([0,3,6,9][e.getMonth()]),n.datepicker("setDate",e))})}function _(e){var i,t;switch((t=n.data("removeSeason"))&&t(),(t=a.data("removeSeason"))&&t(),parseInt(e)){case o:i={forceParse:!1,format:"yyyy",minViewMode:2,startView:1};break;case s:i={format:"yyyy,m季度",minViewMode:1},p(n),p(a);break;case l:i={forceParse:!1,format:"yyyy-mm",minViewMode:1};break;case c:i={format:"yyyy-mm-dd"};break;default:throw new Error("无效的数据格式:"+e)}i=$.extend({},i,{language:"zh-CN",autoclose:!0}),g(n,i),g(a,i)}function g(e,i){var t=e.datepicker("getDate");isNaN(t.getTime())&&(t=e.val()),e.datepicker("remove"),e.datepicker(i),e.datepicker("setDate",t)}function v(e){return/^[0-9]{4}$/g.test(e)?1:/^[0-9]{4}-[0-9]{1,2}$/g.test(e)?3:/^[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}$/g.test(e)?4:/^[1-4]季$/g.test(e)?2:-1}return n.css({cursor:"cell"}),a.css({cursor:"cell"}),t.change(function(){_(t.val())}).prop("checked",!0).trigger("change"),r.change(function(){this.checked?(d.html("时间段"),a.fadeIn()):(d.html("时间点"),a.fadeOut())}).prop("checked",!0).trigger("change"),{DT_DAY:c,DT_YEAR:o,DT_MONTH:l,DT_SEASON:s,changeType:_,completed:u,fix:m,set:function(e){n.val(e.dt_from),a.val(e.dt_to),r.prop("checked",e.flg).trigger("change"),e.dt_type!=s&&_(c),t.val(e.dt_type),_(e.dt_type)},get:function(){var e={dt_from:n.val(),dt_to:a.val(),dt_type:parseInt(t.val()),flg:r.prop("checked"),dt_q:0,autotime:!1};return h(e),e.flg||(e.dt_to=e.dt_from),m(u(e))},rmNotDate:function(t){$.each(t,function(e,i){f[e]||(t[e]=null,delete t[e])})},fill_default:h,parseType:v}},zy_chart._showOrHide=function(t,e,n){$.each(e,function(e,i){1==n?t.find("[index="+i+"]").show():t.find("[index="+i+"]").hide()})},zy_chart._btnDisable=function(t,e,n){$.each(e,function(e,i){1!=n?t.find("[index="+i+"]").btnDisable(!1):t.find("[index="+i+"]").btnDisable(!0)})},zy_chart._getMsg=function(e,i){var t=function(e){e&&i(e)};zy.g.am.app=e.app||zy_chart.g.appnm,zy.g.am.mod=e.mod,void 0!==e.parm?zy.net.post("api/"+e.api,t,e.parm):zy.net.post("api/"+e.api,t)},zy_chart.changeTheme=function(t,n){$.each(zy_chart.g.defaultOptions,function(e,i){t.highcharts().options.title.text==e&&t.highcharts(zy_chart.merge(i,n))})},zy_chart.buildThemeButton=function(e,a){var d=e.find("ul"),t=theme;function n(e,i,t){var n=genid("theme_id");d.append("<li><span data-original-title='"+e+"' data-placement='top'     rel='tooltip' class='"+i+"' id='"+n+"'></span></li>"),d.find("#"+n).click(function(){a(t,e)})}n("默认","bg-color-white",{}),$.each(t,function(e,i){n(i.name,i.className,t[e])})},zy_chart.init_tooltip=function(){}}