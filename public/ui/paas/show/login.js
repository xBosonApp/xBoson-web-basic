Login=function(){function e(){return a=this,this}function t(){var e=$("#register-form"),t=e.find("[name=userid]"),r=e.find("[name=password]"),o=e.find("[name=confirmpassword]"),i=e.find("[name=email]"),s=e.find("[name=tel]"),a=e.find("[name=invitation_code]"),l=e.find("#register-button"),u=null,g=/^[a-zA-Z][a-zA-Z0-9_-]{3,15}$/,m=/^[a-zA-Z0-9_-]{6,32}$/,c=/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/,d=/^(13[0-9]|14[57]|15[0-9]|17[0678]|18[0-9])[0-9]{8}$/,f=/\w{6}/;l.unbind("_change").bind("_change",function(t,r){var o=$(this);if(o.unbind("click"),o.btnDisable(!0),r){if(!g.test(r.userid))return!0;if(!m.test(r.password))return!0;if(r.password!=r.confirmpassword)return!0;if(!c.test(r.email))return!0;if(!d.test(r.tel))return!0;if(!e.find("[name=agree]").is(":checked"))return!0;r.password=$.md5(r.password),delete r.confirmpassword,o.btnDisable(!1),o.click(function(e){zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/register",function(e){zy.ui.msg("提示","注册成功","s"),n($("#cc"));var t=$("#form-section");t.hide(),t.prev().show(),$("#login-header-space a").html("创建用户")},r,null,function(e){n($("#cc")),"0"!=e.ret&&zy.ui.msg("注册失败：",e.msg,"w")})})}}),r.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();m.test(r)?(u=r,t.next().remove()):t.after($("<p>").html("密码规则为6-32位数字,字母,_或-"))}),o.unbind("blur").bind("blur",function(e){var t=$(this).val();t!=u?$(this).after($("<p>").html("两次密码不同")):$(this).next().remove()}),i.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();return""==r?(t.after($("<p>").html("邮箱为必填项")),!0):(t.val(t.val().toLowerCase()),r=t.val(),void(c.test(r)?(t.next().remove(),zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/get_havinguser",function(e){e&&e.result&&"1"==e.result[0].count||t.after($("<p>").html("用户邮箱已被注册！"))},{email:r})):t.after($("<p>").html("邮箱格式不正确"))))}),s.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();return""==r?(t.after($("<p>").html("手机号码为必填项")),!0):void(d.test(r)?(t.next().remove(),zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/get_havinguser",function(e){e&&e.result&&"1"==e.result[0].count||t.after($("<p>").html("此手机号码已被注册！"))},{tel:r})):t.after($("<p>").html("手机号码格式不正确")))}),a.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();return""==r?!0:void(f.test(r)?t.next().remove():t.after($("<p>").html("邀请码格式不正确")))}),t.unbind("blur").blur(function(e){var t=$(this);t.val(t.val().toLowerCase());var r=t.val();g.test(r)?(t.next().remove(),zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/get_havinguser",function(e){e.result&&"1"==e.result[0].count?t.next().remove():t.after($("<p>").html("用户ID已存在"))},{userid:r})):t.after($("<p>").html("用户ID为4-16位数字,字母,_或-,以字母开头"))}),$("#register-form :input").unbind("input").bind("input",function(t){l.trigger("_change",e.form2json())}).unbind("focus").bind("focus",function(e){$(this).siblings("p").remove()}),$("#register-form").find("[name=agree]").bind("change",function(t){l.trigger("_change",e.form2json())}),l.trigger("_change"),l.btnDisable(!0)}function r(){return zy.g.host.api+"captcha?"+Math.round(1e5*Math.random())}function n(e){e.attr("src",r()),e.unbind("click").click(function(){var e=0;return function(t){var n=(new Date).getTime();if(15e3>n-e)return!1;e=n,$("[name=c]").val("");var o=$(this);o.attr("src",r());var i=o.next(),s=15;i.html(s);var a=setInterval(function(){--s,zy.log(s),s>0?i.html(s):(clearInterval(a),i.html(""))},1e3)}}())}function o(e){zy.log("checkCookie: "+e),l.set("user_local_userkey",e),l.set("user_openid",zy.g.comm.openid)}function i(e){var t=$("#login-form").form2json();t.password=$.md5(t.password);var r=function(e){if(e&&(zy.log("login.success: "+JSON.stringify(e)),"0"==e.ret)){l.remove("errorTimeout"),zy.g.comm.openid=e.openid,zy.g.comm.mdk=e.mdk,l.set("user_mdk",e.mdk),o(e.userkey),zy.log("登录之后 zy.g.comm.openid="+zy.g.comm.openid);var t=function(e){if(e)if(l.set("user_org_list",e.result),e.result.length>1){a._g.orgList=e.result;var t=l.get("user_selected_org");if(t){var r=$.grep(a._g.orgList,function(e,r){return e.orgid===t});r.length>0?window.location="main.html":s()}else s()}else if(1==e.result.length){a._g.orgList=e.result,zy.g.comm.org=e.result[0].orgid,zy.g.comm.orgtype=e.result[0].org_type;var n=e.result[0].isplatorg?"paas":"saas/"+e.result[0].orgid;zy.g.comm.orgpath=n,l.set("user_selected_org",e.result[0].orgid),l.set("user_selected_org_type",e.result[0].org_type),l.set("user_selected_org_path",n),window.location="main.html"}else a._g.orgList=[],zy.ui.msg("提示信息：","您尚未被登记为属于任何一个机构的用户，将不能进行任何操作，请联系管理员！","e")};zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_LOGIN",zy.net.get("user/getuserorg",t)}},i=function(e){e&&(l.set("errorTimeout",(new Date).getTime()),"1001"===e.ret?(zy.ui.msg("登录失败：","用户名或密码错误请尝试重新输入","e"),$("#c").closest("section").show(),n($("#c")),$("[name=c]").val("")):"10"===e.ret?(zy.ui.msg("登录失败：","验证码错误请重新输入","e"),$("#c").closest("section").show(),n($("#c")),$("[name=c]").val("")):(zy.ui.msg("登录失败：",e.msg,"e"),$("#c").closest("section").show(),n($("#c")),$("[name=c]").val("")))};zy.log("登录之前 zy.g.comm.openid="+zy.g.comm.openid),zy.g.am.app="",zy.g.am.mod="",zy.net.post("user/login",r,t,null,i),$("#login-form input[name=password]").val("")}function s(){$("#div_login").hide();for(var e='<ol class="dd-list">',t='<li class="dd-item"><div class="dd-handle" data-org="',r=">",n="</div></li>",o=a._g.orgList,i=" data-orgtype=",s=0;s<o.length;s++){var u=o[s].isplatorg?"paas":"saas/"+o[s].orgid;e=e+t+o[s].orgid+'" data-orgpath="'+u+'" '+i+o[s].org_type+r+o[s].orgnm+n}e+="</ol>",$("#org_list").append(e),$("#div_login_org_selection").show(),$(".dd-handle").on("click",function(e){zy.log($(e.target));var t=$(e.target).data("org"),r=$(e.target).data("orgtype"),n=$(e.target).data("orgpath");zy.log(JSON.stringify(l)),l.set("user_selected_org",t),l.set("user_selected_org_type",r),l.set("user_selected_org_path",n),zy.g.comm.org=t,zy.g.comm.orgtype=r,zy.g.comm.orgpath=n,window.location="main.html"})}var a,l,u=e.prototype;return u._g={orgList:[]},u.Events={},u.Init=function(){l=zy.cache.get("_zy_user_info","ls"),zy.g.host.api=zy.net.getHttpUrl("/ds/"),zy.g.host.ui=zy.net.getHttpUrl();var e=l.get("errorTimeout");if(e){var r=(new Date).getTime();9e5>r-e&&($("#c").closest("section").show(),n($("#c")),$("[name=c]").val(""))}$("#login-form input[name=userid]").focus(),t(),n($("#cc")),$("#login-form").validate({rules:{userid:{required:!0,minlength:4,maxlength:20},password:{required:!0,minlength:6,maxlength:20}},messages:{userid:{required:"请输入用户ID"},password:{required:"请输入密码"}},submitHandler:function(e){i(e)},errorPlacement:function(e,t){e.insertAfter(t.parent())}})},e}();