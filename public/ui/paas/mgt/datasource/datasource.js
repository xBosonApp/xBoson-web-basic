MgtDataSource=function(){var d,a=t.prototype;a._g={data:[],param:{},page:1,count:1,crt_page:1};var e=$("#mgt_datasource_dt");function t(){return(d=this).Init(),d.Select(),this}function n(a){Console.log("Pagination page = "+a),$.jqPaginator("#mgt_datasource_pagination",{totalCounts:d._g.count,pageSize:zy.g.page.pagesize,currentPage:a,onPageChange:function(a){Console.log("onPageChange num = "+a),function(t){Console.log("SetDt page = "+t);zy.g.am.app="ZYAPP_SYSMGT",zy.g.am.mod="datasource",zy.net.get("api/getdatasourcelist",function(a){$("#mgt_datasource_search").button("reset"),a&&($("#mgt_datasource_edit").btnDisable(!0),$("#mgt_datasource_delete").btnDisable(!0),d._g.count=a.count,d._g.data=a.result,d.DataTable(a.result),Console.log("if (msg) thiz._g.count = "+d._g.count),0<a.count?$("#mgt_datasource_pagination").jqPaginator("option",{totalCounts:d._g.count,pageSize:zy.g.page.pagesize,currentPage:t}):(d._g.count=1,d._g.page=1,$("#mgt_datasource_pagination").jqPaginator("destroy")))},$("#mgt_datasource_form").serialize(),t)}(d._g.crt_page=a)}})}return a.Init=function(){d.DataTable(),d.Toolbar(),$("#mgt_datasource_edit").btnDisable(!0),$("#mgt_datasource_delete").btnDisable(!0)},a.DataTable=function(a){var t={data:a,columns:[{title:"数据源ID",data:"did"},{title:"数据源名称",data:"dn"},{title:"数据库类型",render:function(a,t,e,d){return zy.cache.cd2name("ZR.0014",e.dbtype)}},{title:"数据库物理名称",data:"en"},{title:"数据库中文名称",data:"cn"},{title:"标记",render:function(a,t,e,d){return zy.cache.cd2name("ZR.0004",e.flg)}},{title:"所有者",data:"orgnm"},{title:"连接池",render:function(a,t,e,d){return zy.cache.cd2name("ZR.0045",e.pool_enabled)}},{title:"状态",render:function(a,t,e,d){var n,o,s,r;return n="data-did='"+e.did+"'",n+=" data-status='"+e.status+"'",r="1"===e.status?(s="","checked='checked'"):(s="checked='checked'",""),o="<div class='radio'><label><input type='radio' name='status' value='0' "+s+"><span>无效</span></label></div>",'<a href="javascript:void(0);" rel="popover" data-placement="left" data-original-title="<i class=\'fa fa-fw fa-pencil\'></i> 修改状态" data-content="<form id=\'mgt_datasource_status_form\' onsubmit=\'return false;\' '+n+" style='min-width:170px'>"+(o+="<div class='radio'><label><input type='radio' name='status' value='1' "+r+"><span>有效</span></label></div>")+"<div class='form-actions'><div class='row'><div class='col-md-12'><button id='mgt_datasource_status_form' class='btn btn-primary btn-sm' type='submit'>保存</button></div></div></div></form>\" data-html=\"true\">"+zy.cache.cd2name("ZR.0001",e.status)+"</a>"}}]};$.extend(t,zy.ui.dataTable),e.dataTable(t),$(".dataTables_scrollHeadInner").css("width","100%"),$(".dataTables_scrollBody table").css("width","100%"),$(".dataTables_scrollHeadInner table").css("width","100%")},a.Toolbar=function(){e.on("click","tr",function(a){if($(this).find("th").is("th")||$(this).find("td").hasClass("dataTables_empty"))return!1;if(Console.log($(a.target).is("button")+"==== "+$(a.target).parents("form").html()),$(a.target).is("button")&&d.SaveStatus($(a.target).parents("form")),!$(this).find("div").hasClass("popover")&&$(this).hasClass("active"))$(this).removeClass("active"),$("#mgt_datasource_edit").btnDisable(!0),$("#mgt_datasource_delete").btnDisable(!0);else{e.DataTable().$("tr.active").removeClass("active"),$(this).addClass("active");e.DataTable().row($(this)).data();$("#mgt_datasource_edit").btnDisable(!1),$("#mgt_datasource_delete").btnDisable(!1)}}),$("#mgt_datasource_search").click(function(){$("#mgt_datasource_edit").btnDisable(!0),$("#mgt_datasource_delete").btnDisable(!0),$("#mgt_datasource_search").button("loading"),n(1)}),$("#mgt_datasource_add").click(function(){d._g.param.flg="i",zy.net.loadHTML("mgt/datasource/add_upddatasource.html",$("#mgt_datasource_form2"),function(){$("#add_upddatasource_title").text("添加")}),d.add_upd()}),$("#mgt_datasource_edit").click(function(){e.DataTable().row(".active").index();var a=e.DataTable().row(".active").data();d._g.param.flg="u",d._g.param.did=a.did,zy.net.loadHTML("mgt/datasource/add_upddatasource.html",$("#mgt_datasource_form2"),function(){d.add_upd();var a={did:d._g.param.did};zy.g.am.app="ZYAPP_SYSMGT",zy.g.am.mod="datasource",zy.net.get("api/getdatasourceupt",function(a){$("#add_upddatasource_form").formDisable(!1),a&&($("#add_upddatasource_form").json2form(a.result[0]),$("#add_upddatasource_form input[name=dbtype]").change())},a),$("#add_upddatasource_title").text("修改"),$("#add_upddatasource_form input[name=did]").attr("readonly",!0),$("#add_upddatasource_b").remove()})}),$("#mgt_datasource_delete").click(function(){zy.ui.mask("删除确认","数据删除后将不能再恢复，是否确定删除该数据？",function(){$("#mgt_third_applist_form").formDisable(!0);var a={},t=e.DataTable().row(".active").data();a.did=t.did,zy.g.am.app="ZYAPP_SYSMGT",zy.g.am.mod="datasource",zy.net.get("api/deletedatasource",function(a){a?($("#mgt_third_applist_form").formDisable(!1),e.DataTable().row(".active").remove().draw(),n(d._g.crt_page),zy.ui.msg("提示信息：","删除成功！","s")):zy.ui.msg("提示","删除失败","e")},a)})})},a.add_upd=function(){var r=$("#add_upddatasource_form"),o=r.find("[name=dbtype]"),s=r.find("[name=en]"),i=r.find("[name=dhost]"),u=r.find("[name=dport]"),c=r.find("[name=url]");$("#add_upddatasource_form input[name=status]").zySelect("ZR.0001",!1,{width:"100%"}),$("#add_upddatasource_form input[name=dbtype]").zySelect("ZR.0014",!1,{width:"100%"}),$("#add_upddatasource_form input[name=flg]").zySelect("ZR.0004",!1,{width:"100%"}),$("#add_upddatasource_form input[name=pool_enabled]").zySelect("ZR.0045",!1,{width:"100%"}),"i"===d._g.param.flg&&($("#add_upddatasource_form input[name=status]").select2("val","1"),$("#add_upddatasource_form input[name=flg]").select2("val","1"),$("#add_upddatasource_form input[name=pool_enabled]").select2("val","0")),$("#add_upddatasource_form input[name=dbtype]").on("change",function(){"03"==$(this).val()||"06"==$(this).val()?$("#add_upddatasource_en").html("SID"):$("#add_upddatasource_en").html("数据库物理名称")}),r.find("[name=dbtype],[name=en],[name=dhost],[name=dport]").change(function(a){var t=o.val(),e=s.val(),d=i.val(),n=u.val();c.val(function(a,t,e,d){zy.log("dbtype="+a+"|en="+t+"|dhost="+e+"|dport="+d);var n="";switch(a){case"01":n="jdbc:mysql://"+e+(d?":"+d:"")+(t?"/"+t:"");break;case"02":n="jdbc:sqlserver://"+e+(d?":"+d:"")+(t?";databaseName="+t:"");break;case"03":n="jdbc:oracle:thin:@"+e+(d?":"+d:"")+(t?":"+t:":ORCL");break;case"04":n="jdbc:db2://"+e+(d?":"+d:"")+(t?"/"+t:"");break;case"05":n="jdbc:mpp://"+e+(d?":"+d:"")+(t?"/"+t:"");break;case"06":n="jdbc:inspur:thin:@"+e+(d?":"+d:"")+(t?":"+t:":kdb");break;default:n=""}return n}(t,e,d,n))}),r.find('button[name="test-jdbc-conn"]').click(function(){var a=r.find("input[name=user_name]").val(),t=r.find("input[name=pass]").val(),e=r.find("input[name=url]").val(),d=r.find("input[name=dbtype]").val(),n=r.find("input[name=dhost]").val(),o=r.find("input[name=dport]").val(),s=r.find("input[name=en]").val();return a?t?(zy.g.am.app="ZYAPP_SYSMGT",zy.g.am.mod="datasource",void zy.net.get("api/test_jdbc_conn",function(a){a&&"0"==a.ret&&(a.result&&a.result[0]?"1"==a.result[0].isconn?(zy.ui.msg("提示信息：","连接成功","s"),!e&&a.jdbc_url&&r.find("input[name=url]").val(a.jdbc_url)):zy.ui.msg("提示信息：","连接失败："+a.result[0].message,"i"):zy.ui.msg("提示信息：","连接失败：","s"))},{user_name:a,pass:t,url:e,host:n,port:o,type:d,db:s})):zy.ui.msg("提示：","请输入密码","i"):zy.ui.msg("提示：","请输入用户名","i")}),zy.g.am.app="zyapp_login",zy.g.am.mod="zymodule_login",zy.net.post("api/getuserorgtype",function(a){a.result[0].isplatorg||($("#add_upddatasource_form input[name=flg]").select2("val","1"),$("#add_upddatasource_form input[name=flg]").attr("readonly",!0))}),$("#add_upddatasource").modal("show"),$("#add_upddatasource_form").validate({rules:{user_name:{required:!0,maxlength:50},dbtype:{required:!0},en:{maxlength:32},cn:{required:!0,maxlength:150},dhost:{required:!0,maxlength:50},dport:{required:!0,maxlength:11},url:{maxlength:200},pass:{maxlength:50},mark:{maxlength:600}},submitHandler:function(a){var t=function(a){$("#add_upddatasource_form").formDisable(!1),a&&("u"==d._g.param.flg&&d.SetRow($("#add_upddatasource_form").form2json()),$("#add_upddatasource").modal("hide"),zy.ui.msg("提示信息：","保存成功！","s")),d.UpDt()};zy.g.am.app="ZYAPP_SYSMGT",zy.g.am.mod="datasource","i"==d._g.param.flg?zy.net.post("api/adddatasource",t,$("#add_upddatasource_form").serialize()):"u"==d._g.param.flg&&zy.net.post("api/setdatasource",t,$("#add_upddatasource_form").serialize()),$("#add_upddatasource_form").formDisable(!0)},errorPlacement:function(a,t){a.insertAfter(t.parent())}})},a.UpDt=function(){n(1)},a.SetRow=function(a){Console.log("SetRow msg = "+JSON.stringify(a));var t=e.DataTable().row(".active").data();$.extend(t,a),"1"===t.status?t.statusnm="有效":t.statusnm="失效",Console.log("更新后的行数据 = "+JSON.stringify(t)),e.DataTable().rows().invalidate().draw()},a.SaveStatus=function(a){var t={},e=zy.ui.form.getRadioValue("status",a);if(e!=a.data("status")){t.did=a.data("did"),t.status=e,zy.g.am.app="ZYAPP_SYSMGT",zy.g.am.mod="datasource",zy.net.get("api/setdatasourcestatus",function(a){a&&(d.SetRow(t),$("[rel=popover]").each(function(){$(this).popover("hide")}),zy.ui.msg("提示信息：","保存【状态】成功！","s")),d.UpDt()},t)}},a.Select=function(){zy.cache.initDicts("ZR.0001,ZR.0014,ZR.0004,ZR.0045",function(){$("#mgt_datasource_form input[name=status]").zySelect("ZR.0001",!0,{width:"100%"}),$("#mgt_datasource_form input[name=status]").select2("val","1")})},t}();