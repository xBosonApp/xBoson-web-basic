Login=function(){var p,h,e=t.prototype,n=5;function t(){return p=this}function v(e){if(--n<0||e){var t=$("#c"),r=t.closest("section").show();b(t),r.find("[name=c]").val("")}}function s(){return zy.g.host.api+"captcha?"+Math.round(1e5*Math.random())}function b(e){var a;e.attr("src",s()),e.unbind("click").click((a=0,function(e){var t=(new Date).getTime();if(t-a<15e3)return!1;a=t,$("[name=c]").val("");var r=$(this);r.attr("src",s());var n=r.next(),i=15;n.html(i);var o=setInterval(function(){--i,zy.log(i),0<i?n.html(i):(clearInterval(o),n.html(""))},1e3)}))}function _(){$("#div_login").hide();for(var e='<ol class="dd-list">',t='<li class="dd-item"><div class="dd-handle" data-org="',r=">",n="</div></li>",i=p._g.orgList,o=" data-orgtype=",a=0;a<i.length;a++){var s=i[a].isplatorg?"paas":"saas/"+i[a].orgid;e=e+t+i[a].orgid+'" data-orgpath="'+s+'" '+o+i[a].org_type+r+i[a].orgnm+n}e=e+"</ol>",$("#org_list").append(e),$("#div_login_org_selection").show(),$(".dd-handle").on("click",function(e){zy.log($(e.target));var t=$(e.target).data("org");var r=$(e.target).data("orgtype");var n=$(e.target).data("orgpath");zy.log(JSON.stringify(h));h.set("user_selected_org",t);h.set("user_selected_org_type",r);h.set("user_selected_org_path",n);zy.g.comm.org=t;zy.g.comm.orgtype=r;zy.g.comm.orgpath=n;zy.net.loadIndex()})}return e._g={orgList:[]},e.Events={},e.Init=function(){h=zy.cache.get("_zy_user_info","ls"),zy.check_xboson_system();var n,e,t,r,i,o,a,s,l,u,d,g,c,m,f=h.get("errorTimeout");f&&((new Date).getTime()-f<9e5&&v());$("#login-form input[name=userid]").focus(),n=$("#register-form"),e=n.find("[name=userid]"),t=n.find("[name=password]"),r=n.find("[name=confirmpassword]"),i=n.find("[name=email]"),o=n.find("[name=tel]"),a=n.find("[name=invitation_code]"),s=n.find("#register-button"),l=null,u=/^[a-zA-Z][a-zA-Z0-9_-]{3,15}$/,d=/^[a-zA-Z0-9_-]{6,32}$/,g=/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/,c=/^(13[0-9]|14[57]|15[0-9]|17[0678]|18[0-9])[0-9]{8}$/,m=/\w{6}/,s.unbind("_change").bind("_change",function(e,t){var r=$(this);if(r.unbind("click"),r.btnDisable(!0),t){if(!u.test(t.userid))return!0;if(!d.test(t.password))return!0;if(t.password!=t.confirmpassword)return!0;if(!g.test(t.email))return!0;if(!c.test(t.tel))return!0;if(!n.find("[name=agree]").is(":checked"))return!0;t.password=$.md5(t.password),delete t.confirmpassword,r.btnDisable(!1),r.click(function(e){zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/register",function(e){zy.ui.msg("提示","注册成功","s"),b($("#cc"));var t=$("#form-section");t.hide(),t.prev().show(),$("#login-header-space a").html("创建用户")},t,null,function(e){b($("#cc")),"0"!=e.ret&&zy.ui.msg("注册失败：",e.msg,"w")})})}}),t.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();d.test(r)?(l=r,t.next().remove()):t.after($("<p>").html("密码规则为6-32位数字,字母,_或-"))}),r.unbind("blur").bind("blur",function(e){$(this).val()!=l?$(this).after($("<p>").html("两次密码不同")):$(this).next().remove()}),i.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();if(""==r)return t.after($("<p>").html("邮箱为必填项")),!0;t.val(t.val().toLowerCase()),r=t.val(),g.test(r)?(t.next().remove(),zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/get_havinguser",function(e){e&&e.result&&"1"==e.result[0].count||t.after($("<p>").html("用户邮箱已被注册！"))},{email:r})):t.after($("<p>").html("邮箱格式不正确"))}),o.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();if(""==r)return t.after($("<p>").html("手机号码为必填项")),!0;c.test(r)?(t.next().remove(),zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/get_havinguser",function(e){e&&e.result&&"1"==e.result[0].count||t.after($("<p>").html("此手机号码已被注册！"))},{tel:r})):t.after($("<p>").html("手机号码格式不正确"))}),a.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();if(""==r)return!0;m.test(r)?t.next().remove():t.after($("<p>").html("邀请码格式不正确"))}),e.unbind("blur").blur(function(e){var t=$(this);t.val(t.val().toLowerCase());var r=t.val();u.test(r)||t.after($("<p>").html("用户ID为4-16位数字,字母,_或-,以字母开头"))}),$("#register-form :input").unbind("input").bind("input",function(e){s.trigger("_change",n.form2json())}).unbind("focus").bind("focus",function(e){$(this).siblings("p").remove()}),$("#register-form").find("[name=agree]").bind("change",function(e){s.trigger("_change",n.form2json())}),s.trigger("_change"),s.btnDisable(!0),b($("#cc")),$("#login-form").validate({rules:{userid:{required:!0,minlength:4,maxlength:20},password:{required:!0,minlength:6,maxlength:20}},messages:{userid:{required:"请输入用户ID"},password:{required:"请输入密码"}},submitHandler:function(e){!function(e){var t=$("#login-form").form2json();t.password=$.md5(t.password);zy.log("登录之前 zy.g.comm.openid="+zy.g.comm.openid),zy.g.am.app="",zy.g.am.mod="",zy.net.post("user/login",function(e){if(e&&(zy.log("login.success: "+JSON.stringify(e)),"0"==e.ret)){h.remove("errorTimeout"),zy.g.comm.openid=e.openid,zy.g.comm.mdk=e.mdk,h.set("user_mdk",e.mdk),r=e.userkey,zy.log("checkCookie: "+r),h.set("user_local_userkey",r),h.set("user_openid",zy.g.comm.openid),zy.log("登录之后 zy.g.comm.openid="+zy.g.comm.openid);var t=function(e){if(e)if(h.set("user_org_list",e.result),1<e.result.length){p._g.orgList=e.result;var r=h.get("user_selected_org");if(r)$.grep(p._g.orgList,function(e,t){return e.orgid===r});_()}else if(1==e.result.length){p._g.orgList=e.result,zy.g.comm.org=e.result[0].orgid,zy.g.comm.orgtype=e.result[0].org_type;var t=e.result[0].isplatorg?"paas":"saas/"+e.result[0].orgid;zy.g.comm.orgpath=t,h.set("user_selected_org",e.result[0].orgid),h.set("user_selected_org_type",e.result[0].org_type),h.set("user_selected_org_path",t),zy.net.loadIndex()}else p._g.orgList=[],zy.ui.msg("提示信息：","您尚未被登记为属于任何一个机构的用户，将不能进行任何操作，请联系管理员！","e")};zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_LOGIN",zy.net.get("user/getuserorg",t)}var r},t,null,function(e){e&&(h.set("errorTimeout",(new Date).getTime()),"1001"===e.ret?(zy.ui.msg("登录失败：","用户名或密码错误请尝试重新输入","e"),v(),$("#login-form input[name=password]").val("")):"10"===e.ret?(zy.ui.msg("登录失败：","验证码错误请重新输入","e"),v(!0)):(zy.ui.msg("登录失败：",e.msg,"e"),v(),$("#login-form input[name=password]").val("")))})}()},errorPlacement:function(e,t){e.insertAfter(t.parent())}})},t}(),$(function(){var e=new Login;$("#form-password").hide(),e.Init(),$("#login-header-space a").click(function(){var e=$("#form-section");$("#div_login").find("input").val(""),$("#form-password").hide(),e.is(":visible")?(e.hide(),e.prev().show(),$(this).html("创建用户")):(e.show(),e.prev().hide(),$(this).html("登陆"))});var t=$("#wxLogin").click(function(){zy.net.get("openapp/a297dfacd7a84eab9656675f61750078/af1880a8938f4756a3f377c93be99d78/wx_website/redirect_uri",function(e){0==e.code&&(location.href=e.msg)})});function n(){$("#get_valwords").btnDisable(!0),$("#forgotpassword-form label.verify input").blur(function(){validator.element($(this))?$("#get_valwords").btnDisable(!1):$("#get_valwords").btnDisable(!0)}).keyup(function(){$(this).triggerHandler("blur")}).focus(function(){$(this).triggerHandler("blur")})}80!=location.port&&443!=location.port&&""!==location.port||(t.show(),$.get(zy.g.host.api+"user/logout",console.log)),$("#i-agree").click(function(){$this=$("#agree"),$this.checked||$this.prop("checked",!0),$("#myModal").modal("toggle")}),$("#repw").click(function(){var r,e=$("#form-password");e.show(),e.prev().hide(),e.prev().prev().hide(),$("input[name=email]").detach(),$("#tel_forgotpassword").btnDisable(!0),$("#email_forgotpassword").btnDisable(!1),n(),r=60,$("#get_valwords").on("click",function(e){!function e(t){0==r?(t.btnDisable(!1),t.val("获取验证码"),r=60):(t.btnDisable(!0),t.val("重新发送"+r),r--,setTimeout(function(){e(t)},1e3))}($(this))})}),validator=$("#forgotpassword-form").validate({rules:{userid:{required:!0,minlength:4,maxlength:16},tel:{required:!0,tel:!0},email:{required:!0,email:!0},newpassword:{required:!0,minlength:6,maxlength:16},valwords:{required:!0,minlength:6,maxlength:6}},messages:{userid:{required:"请输入用户ID"},tel:{required:"请输入手机号码"},email:{required:"请输入电子邮箱"},newpassword:{required:"请输入新密码"},valwords:{required:"请输入验证码"}},onfocusout:function(e){$(e).valid()},onkeyup:function(e){$(e).valid()},errorElement:"b",errorPlacement:function(e,t){t.is(":checkbox")?e.appendTo(t.parent()).css("color","red"):e.appendTo(t.parent()).addClass("tooltip tooltip-top-right")},highlight:function(e,t,r){$(e).parent().addClass("has-error"),$(e).parent().find("i").css("color","red")},unhighlight:function(e,t,r){$(e).parent().removeClass("has-error"),$(e).parent().find("i").css("color","green")},submitHandler:function(t){$("#forgotpassword-button").click(function(e){Submit(t)})}}),$.validator.addMethod("tel",function(e,t){var r=e.length;return this.optional(t)||11==r&&/^(13[0-9]|14[57]|15[012356789]|17[678]|18[0-9])[0-9]{8}$/.test(e)},"请输入正确的手机号码"),$(".forgotpassword").on("click","button",function(){$current=$(this),$other=$(this).parent().siblings().find("button"),currentName=$(this).attr("name"),otherName=$(this).parent().siblings().find("button").attr("name"),$current.btnDisable(!0).addClass("btn-primary"),$other.btnDisable(!1).removeClass("btn-primary"),$("input[name="+otherName+"]").detach(),$(this).is("#tel_forgotpassword")?$("#"+currentName).parent().find("i").after('<input type="text" name="tel" placeholder="手机号码">'):$("#"+currentName).parent().find("i").after('<input type="text" name="email" placeholder="电子邮箱">'),$("#forgotpassword-form label").removeClass("has-error"),$("#forgotpassword-form label i").removeAttr("style"),validator.resetForm(),$("#get_valwords").btnDisable(!0),n()})});