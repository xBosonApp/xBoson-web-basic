Login=function(){var p,h,e=t.prototype,n=5;function t(){return p=this}function _(e){if(--n<0||e){var t=$("#c"),r=t.closest("section").show();y(t),r.find("[name=c]").val("")}}function a(){return zy.g.host.api+"captcha?"+Math.round(1e5*Math.random())}function y(e){var s;e.attr("src",a()),e.unbind("click").click((s=0,function(e){var t=(new Date).getTime();if(t-s<15e3)return!1;s=t,$("[name=c]").val("");var r=$(this);r.attr("src",a());var n=r.next(),i=15;n.html(i);var o=setInterval(function(){--i,zy.log(i),0<i?n.html(i):(clearInterval(o),n.html(""))},1e3)}))}function v(){$("#div_login").hide();for(var e='<ol class="dd-list">',t='<li class="dd-item"><div class="dd-handle" data-org="',r=">",n="</div></li>",i=p._g.orgList,o=" data-orgtype=",s=0;s<i.length;s++){var a=i[s].isplatorg?"paas":"saas/"+i[s].orgid;e=e+t+i[s].orgid+'" data-orgpath="'+a+'" '+o+i[s].org_type+r+i[s].orgnm+n}e=e+"</ol>",$("#org_list").append(e),$("#div_login_org_selection").show(),$(".dd-handle").on("click",function(e){zy.log($(e.target));var t=$(e.target).data("org");var r=$(e.target).data("orgtype");var n=$(e.target).data("orgpath");zy.log(JSON.stringify(h));h.set("user_selected_org",t);h.set("user_selected_org_type",r);h.set("user_selected_org_path",n);zy.g.comm.org=t;zy.g.comm.orgtype=r;zy.g.comm.orgpath=n;zy.net.loadIndex()})}return e._g={orgList:[]},e.Events={},e.Init=function(){h=zy.cache.get("_zy_user_info","ls"),zy.check_xboson_system();var n,e,t,r,i,o,s,a,g,u,l,m,d,c,f=h.get("errorTimeout");f&&((new Date).getTime()-f<9e5&&_());$("#login-form input[name=userid]").focus(),n=$("#register-form"),e=n.find("[name=userid]"),t=n.find("[name=password]"),r=n.find("[name=confirmpassword]"),i=n.find("[name=email]"),o=n.find("[name=tel]"),s=n.find("[name=invitation_code]"),a=n.find("#register-button"),g=null,u=/^[a-zA-Z][a-zA-Z0-9_-]{3,15}$/,l=/^[a-zA-Z0-9_-]{6,32}$/,m=/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/,d=/^(13[0-9]|14[57]|15[0-9]|17[0678]|18[0-9])[0-9]{8}$/,c=/\w{6}/,a.unbind("_change").bind("_change",function(e,t){var r=$(this);if(r.unbind("click"),r.btnDisable(!0),t){if(!u.test(t.userid))return!0;if(!l.test(t.password))return!0;if(t.password!=t.confirmpassword)return!0;if(!m.test(t.email))return!0;if(!d.test(t.tel))return!0;if(!n.find("[name=agree]").is(":checked"))return!0;t.password=$.md5(t.password),delete t.confirmpassword,r.btnDisable(!1),r.click(function(e){zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/register",function(e){zy.ui.msg("提示","注册成功","s"),y($("#cc"));var t=$("#form-section");t.hide(),t.prev().show(),$("#login-header-space a").html("创建用户")},t,null,function(e){y($("#cc")),"0"!=e.ret&&zy.ui.msg("注册失败：",e.msg,"w")})})}}),t.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();l.test(r)?(g=r,t.next().remove()):t.after($("<p>").html("密码规则为6-32位数字,字母,_或-"))}),r.unbind("blur").bind("blur",function(e){$(this).val()!=g?$(this).after($("<p>").html("两次密码不同")):$(this).next().remove()}),i.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();if(""==r)return t.after($("<p>").html("邮箱为必填项")),!0;t.val(t.val().toLowerCase()),r=t.val(),m.test(r)?(t.next().remove(),zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/get_havinguser",function(e){e&&e.result&&"1"==e.result[0].count||t.after($("<p>").html("用户邮箱已被注册！"))},{email:r})):t.after($("<p>").html("邮箱格式不正确"))}),o.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();if(""==r)return t.after($("<p>").html("手机号码为必填项")),!0;d.test(r)?(t.next().remove(),zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_REG",zy.net.post("user/get_havinguser",function(e){e&&e.result&&"1"==e.result[0].count||t.after($("<p>").html("此手机号码已被注册！"))},{tel:r})):t.after($("<p>").html("手机号码格式不正确"))}),s.unbind("blur").bind("blur",function(e){var t=$(this),r=t.val();if(""==r)return!0;c.test(r)?t.next().remove():t.after($("<p>").html("邀请码格式不正确"))}),e.unbind("blur").blur(function(e){var t=$(this);t.val(t.val().toLowerCase());var r=t.val();u.test(r)||t.after($("<p>").html("用户ID为4-16位数字,字母,_或-,以字母开头"))}),$("#register-form :input").unbind("input").bind("input",function(e){a.trigger("_change",n.form2json())}).unbind("focus").bind("focus",function(e){$(this).siblings("p").remove()}),$("#register-form").find("[name=agree]").bind("change",function(e){a.trigger("_change",n.form2json())}),a.trigger("_change"),a.btnDisable(!0),y($("#cc")),$("#login-form").validate({rules:{userid:{required:!0,minlength:4,maxlength:20},password:{required:!0,minlength:6,maxlength:20}},messages:{userid:{required:"请输入用户ID"},password:{required:"请输入密码"}},submitHandler:function(e){!function(e){var t=$("#login-form").form2json();t.password=$.md5(t.password);zy.log("登录之前 zy.g.comm.openid="+zy.g.comm.openid),zy.g.am.app="",zy.g.am.mod="",zy.net.post("user/login",function(e){if(e&&(zy.log("login.success: "+JSON.stringify(e)),"0"==e.ret)){h.remove("errorTimeout"),zy.g.comm.openid=e.openid,zy.g.comm.mdk=e.mdk,h.set("user_mdk",e.mdk),r=e.userkey,zy.log("checkCookie: "+r),h.set("user_local_userkey",r),h.set("user_openid",zy.g.comm.openid),zy.log("登录之后 zy.g.comm.openid="+zy.g.comm.openid);var t=function(e){if(e)if(h.set("user_org_list",e.result),1<e.result.length){p._g.orgList=e.result;var r=h.get("user_selected_org");if(r)$.grep(p._g.orgList,function(e,t){return e.orgid===r});v()}else if(1==e.result.length){p._g.orgList=e.result,zy.g.comm.org=e.result[0].orgid,zy.g.comm.orgtype=e.result[0].org_type;var t=e.result[0].isplatorg?"paas":"saas/"+e.result[0].orgid;zy.g.comm.orgpath=t,h.set("user_selected_org",e.result[0].orgid),h.set("user_selected_org_type",e.result[0].org_type),h.set("user_selected_org_path",t),zy.net.loadIndex()}else p._g.orgList=[],zy.ui.msg("提示信息：","您尚未被登记为属于任何一个机构的用户，将不能进行任何操作，请联系管理员！","e")};zy.g.am.app="ZYAPP_LOGIN",zy.g.am.mod="ZYMODULE_LOGIN",zy.net.get("user/getuserorg",t)}var r},t,null,function(e){e&&(h.set("errorTimeout",(new Date).getTime()),"1001"===e.ret?(zy.ui.msg("登录失败：","用户名或密码错误请尝试重新输入","e"),_(),$("#login-form input[name=password]").val("")):"10"===e.ret?(zy.ui.msg("登录失败：","验证码错误请重新输入","e"),_(!0)):(zy.ui.msg("登录失败：",e.msg,"e"),_(),$("#login-form input[name=password]").val("")))})}()},errorPlacement:function(e,t){e.insertAfter(t.parent())}})},t}();